<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMS Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0f1115; color:#e6e7ea; }
    header { padding:16px 20px; font-size:22px; font-weight:700; background:#12141a; border-bottom:1px solid #22252e; }
    main { max-width: 900px; margin: 0 auto; padding: 16px; }
    .list { display: flex; flex-direction: column; gap: 12px; }
    .card { background:#141823; border:1px solid #232835; border-radius:14px; padding:14px 16px; display:grid; grid-template-columns: 1fr auto; gap:10px; }
    .meta { font-size:13px; opacity:.85; }
    .row { margin:2px 0; }
    .text { grid-column: 1 / -1; white-space: pre-wrap; word-break: break-word; font-size:15px; }
    .btn-del { align-self:start; padding:8px 10px; border-radius:10px; border:1px solid #3a4254; background:#1b2130; color:#f3f4f6; cursor:pointer; }
    .btn-del:hover { background:#222a3d; }
    .empty { opacity:.7; text-align:center; padding:40px 0; }
    a { color:#bcd3ff; text-decoration:none; }

    /* মোবাইল নম্বর হাইলাইট - র‍্যান্ডম কালার JS-এ দেওয়া হবে */
    .to-number { font-weight:700; }
  </style>
</head>
<body>
  <header>SMS Receiver</header>
  <main>
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No messages yet.</div>
  </main>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');

    const state = new Map(); // id -> record

    // র‍্যান্ডম কালার জেনারেটর
    function getRandomColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      
      // ব্রাইট কালার জেনারেট করি (HSL ব্যবহার করে)
      const h = Math.abs(hash % 360);
      const s = 70 + (Math.abs(hash >> 8) % 20); // 70-90%
      const l = 55 + (Math.abs(hash >> 16) % 20); // 55-75%
      
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    function setEmpty() {
      emptyEl.style.display = state.size ? 'none' : 'block';
    }

    function cardTpl(rec) {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.id = `msg-${rec.id}`;
      
      // to ফিল্ডের জন্য র‍্যান্ডম কালার
      const toColor = getRandomColor(rec.to || 'unknown');
      
      wrap.innerHTML = `
        <div>
          <div class="meta row"><strong>time:</strong> ${escapeHtml(rec.time || rec.receivedAt || '')}</div>
          <div class="meta row"><strong>to:</strong> <span class="to-number" style="color: ${toColor}">${escapeHtml(rec.to || 'Unknown')}</span></div>
          <div class="text"><strong>text:</strong> ${escapeHtml(rec.message || rec.text || '')}</div>
        </div>
        <div>
          <button class="btn-del" data-id="${rec.id}" title="Delete this message">Delete</button>
        </div>
      `;
      
      wrap.querySelector('.btn-del').addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        try { 
          await fetch(`/api/messages/${id}`, { method: 'DELETE' }); 
        } catch (err) { 
          console.error(err); 
        }
      });
      
      return wrap;
    }

    // নতুন কার্ড সবসময় তালিকার শুরুর দিকে বসানো হবে
    function addTop(rec) {
      state.set(rec.id, rec);
      const el = cardTpl(rec);
      if (listEl.firstChild) listEl.insertBefore(el, listEl.firstChild);
      else listEl.appendChild(el);
      setEmpty();
    }

    function removeCard(id) {
      state.delete(id);
      const el = document.getElementById(`msg-${id}`);
      if (el) el.remove();
      setEmpty();
    }

    // Escape helper
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Live SSE
    function bootSSE() {
      const es = new EventSource('/events');
      
      es.addEventListener('init', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          listEl.innerHTML = '';
          state.clear();
          // reverse করে addTop, ফলে লেটেস্ট একেবারে উপরে
          for (const rec of data.slice().reverse()) addTop(rec);
        } catch (e) { console.warn('init parse failed', e); }
      });

      es.addEventListener('new', (ev) => {
        try {
          const rec = JSON.parse(ev.data);
          addTop(rec);
        } catch (e) { console.warn('new parse failed', e); }
      });

      es.addEventListener('delete', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          removeCard(data.id);
        } catch (e) { console.warn('delete parse failed', e); }
      });

      es.onerror = () => console.warn('SSE disconnected…');
    }

    // Fallback REST API for initial load
    async function bootFetch() {
      try {
        const arr = await (await fetch('/api/messages')).json();
        listEl.innerHTML = '';
        state.clear();
        for (const rec of arr.slice().reverse()) addTop(rec);
      } catch (e) { console.warn('init fetch failed', e); }
    }

    // Socket.IO (SSE না থাকলে)
    function bootSocketIO() {
      const socket = io();
      
      socket.on('init', (msgs) => {
        listEl.innerHTML = '';
        state.clear();
        for (const rec of msgs.slice().reverse()) addTop(rec);
      });
      
      socket.on('new', (rec) => addTop(rec));
      
      socket.on('delete', (data) => removeCard(data.id));
    }

    // Try SSE first, fallback to Socket.IO
    if (typeof EventSource !== 'undefined') {
      bootSSE();
    } else {
      // Load Socket.IO script if needed
      const script = document.createElement('script');
      script.src = '/socket.io/socket.io.js';
      script.onload = bootSocketIO;
      document.head.appendChild(script);
    }
    
    // Also fetch initial data via REST as backup
    bootFetch();
  </script>
</body>
</html>
